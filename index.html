
<!DOCTYPE html>
<meta charset="utf-8">
<title>SANKEY Experiment</title>
<script type="text/javascript" src="d3.v3.js"></script>
<script src="d3-plugins-master/sankey/sankey.js"></script>
<script src="http://code.jquery.com/jquery.js"></script>
<script src="js/bootstrap.js"></script>
<link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
<style>
.axis path,
		.axis line {
			fill:none;
			stroke: black;
			shape-rendering: crispEdges;
		}
		.axis text {
			font-family:sans-serif;
			font-size: 11px;
		}
		.button {
			background: white;
			border-radius: 10px;
			width: 80px;
			height: 40px;
			border: 1px solid black;
			font: 25px Georgia;
			margin-left:15px;
			
		}
		.year.label {
  font: 400 30px "Helvetica Neue";
  fill: #ddd;
}

.year.label2 {
  font: 400 13px "Helvetica Neue";
  fill: #ddd;
}

		div.tooltip {
		background: rgba(153,204,255,.5);
	position: absolute;
	text-align: center;
	width: 160px;
	height: 28px;
	padding: 2px;
	font: 15px "Helvetica Neue";
	border: 0px;
	border-radius: 8px;
	pointer-events: none;
	fill: black;
}
.node rect {
  cursor: move;
  fill-opacity: .9;
  shape-rendering: crispEdges;
}

.node text {
  pointer-events: none;
  text-shadow: 0 1px 0 #fff;
  font: 10px sans-serif;
}

.link {
  fill: none;
  stroke: #000;
  stroke-opacity: .2;
}

.link:hover {
  stroke-opacity: .5;
}

.row{
	font-family:"Avant Garde";
    background-color:white;
    color:black;
	text-align: left;
}

body {padding-top: 10px;
	  padding-bottom: 20px;
  }

</style>

<div class="container">			
	<div class="col-xs-12 text-center" >
		<div class="row" style="margin:10px">
        	<h1>Sankey Example for Chile</h1>
        	<p>Responsive diagram with moveable nodes</p>
        </div>
	</div>
</div>
</br>
<div class="container">	
	<div class="col-xs-12">
		<div id="area1"></div>
		<p></br>
		<p> Sankey diagrams visualize the magnitude of flow between nodes in a network. This intricate diagram shows a 				possible scenario: energy supplies are on the left, and demands are on the right. Intermediate nodes group 				related forms of production and show how energy is converted and transmitted before it is consumed (or 				lost!). The thickness of each link encodes the amount of flow from source to target. </p>

		<p> This example is built with D3’s Sankey plugin. The plugin takes as input the nodes and weighted links, 				computing positions via iterative relaxation. After fixing the horizontal position of each node, the 			  algorithm starts from the sources on the left, positioning downstream nodes so as to minimize link 			  distance. A reverse pass is then made from right-to-left, and then the entire process is repeated several 			 times. Overlapping nodes are shifted to avoid collision. </p>

		<p> The d3.sankey API is similar to D3’s force-directed graph layout, which is another type of network 				visualization. The fully automatic layout is convenient for rapid visualization—positioning nodes manually 				is tedious! However, the algorithm is not perfect; links are drawn with partial transparency to 			 highlight crossings. To improve readability and further disambiguate links, this example also lets you 			 reposition nodes interactively. </p>	
</div>
</div>

</br></br>
			
	<!-- START THE FEATURETTES -->
		<div class="container">
			<div class="container marketing">
				
			      <hr class="featurette-divider">
				  <hr class="featurette-divider">
			</div>
		</div>
	<!-- END THE FEATURETTES -->
</br></br>


<div class="container">			
	<div class="col-xs-12 text-center" >
		<div class="row" style="margin:10px">
        	<h1>1965-2010 - GDP growth compared to GDP</h1>
        	<p> Click years to move through time (Blue circle represents Chile -- hover over for country names) </p>
        </div>
	</div>
</div>

<div class="container">	
<div class="col-md-12">
		<div id="option">
			<input name="update1965"
			type="button"
			class="button"
			class="btn btn-large"
			value="1965"
			data-toggle="tooltip"
			title="update 1965"
			data-placement="bottom"
			onclick="do_year(1965);" />

			<input name="update1970"
			type="button"
			class="button"
			value="1970"
			onclick="do_year(1970);" />

			<input name="update1975"
			type="button"
			class="button"
			value="1975"
			onclick="do_year(1975);" />

			<input name="update1980"
			type="button"
			class="button"
			value="1980"
			onclick="do_year(1980);" />

			<input name="update1990"
			type="button"
			class="button"
			value="1990"
			onclick="do_year(1990);" />
			
			<input name="update1995"
			type="button"
			class="button"
			value="1995"
			onclick="do_year(1995);" />
			
			<input name="update2000"
			type="button"
			class="button"
			value="2000"
			onclick="do_year(2000);" />
			
			<input name="update2005"
			type="button"
			class="button"
			value="2005"
			onclick="do_year(2005);" />
			
			
		</div>
	<div class="col-md-12">
		<div id = "area2"></div>
		<p></br>
		<p> This scatterplot measures current GDP (in trillions of US dollars) compared to GDP growth (as measured by annual percent growth). I have subsetted the countries to latin American countries with full sets of data
		between the years 1965 and 2005, and with a total GDP at any point of less than 200 trillions current US dollars. The blue circle represents Chile while the grey circles represent all other represente countries. The
		radius of the circle indicates relative population. </p>
	</div>
</div>
	
		<script type="text/javascript">
		
		//var dataset = [];
		var w = 800;
		var h = 500;
		var padding = 35;
		
		var div = d3.select("body").append("div")
		.attr("class","tooltip")
		.style("opacity",0);
		
		var svg2 = d3.select("#area2")
					.append("svg")
					.attr("width",w)
					.attr("height",h);
		
		var color = d3.scale.category20c();
		
					
		
		d3.csv("latin_popGDP_after_R_2.csv", function(data) {
			window.orig_data = data;
			var dataset = data.filter(function(d) { return d.year == "1965"; });
			do_viz(dataset);
		});

	
	
	function do_year(year) {
		// <div class="btn" onclick="do_year(2009);"></div>
		var dataset = window.orig_data.filter(function(d) { return d.year == year; });
		do_viz(dataset);
		
	}
	function do_viz(dataset) {
		
		var xScale = d3.scale.linear()
								 .domain([-15.47878886, 20])
								 .range([padding, w-padding]);

		var yScale = d3.scale.linear()
								 //.domain([0, d3.max(dataset, function(d) { return d.sgp; })])
								 .domain([0,200])
								 .range([h-padding, padding]);
		
		
								 
		//Create x and y axis
		var xAxis = d3.svg.axis()
						.scale(xScale)
						.orient("bottom");
		
		//formatValue = d3.format(".2s");
		
		var yAxis = d3.svg.axis()
						.scale(yScale)
						//.tickFormat(function(d) { return formatValue(d)})
						.orient("left");
		var r_scale = d3.scale.linear()
						//.domain(d3.extent(dataset, function(d) {return d.n_sgp;}))
						.domain([82144,43184026])
						.range([10,30]);
						
		var label = svg2.append("text")
    		.attr("class", "year label")
    		.attr("text-anchor", "end")
    		.attr("y", height - 24)
    		.attr("x", width-padding-50)
    		.text("GDP Growth");
    	
    	svg2.append("text")
    		.attr("class", "year label")
    		.attr("text-anchor", "end")
    		.attr("x",-35)
    		.attr("y", 45)
    		.attr("dy", ".75em")
    		.attr("transform", "rotate(-90)")
    		.text("GDP (Current $US)");
							
		var circles = svg2.selectAll("circle")
			.data(dataset, function(d) { return d.year + d.Country;})
			
		circles
			.enter()
			.append("circle")
			.attr("cx", function(d) {
			   		return xScale(d.GDP_growth);
			   })
			.attr("cy", function(d) {
			   		return yScale(d.GDP);
			   })
			//.attr("r",5)
			.attr("r", function(d) {
			return r_scale(d.Population);
			})
			//.style("fill", function(d) {return(color(d.Country) )})
			.style("fill", function(d) {
				if (d.TF == 1) { 
    			return "blue";
  			}
  			else if(d.TF==0){
    			return 'grey';
  			}
  			})
			//.attr('opacity', function(d) {
  			/*if (d.TF == 0) { 
    			return "1.0";
  			}
  			else if(d.TF==1){
    			return '.5';
  			}
  			});*/
			
			//.attr("fill", "rgba(0, 0, 0, 0.5)")
			.attr("stroke-width", .5)
			.attr("stroke", "black")
			.attr("opacity", "0.7");
			//.filter(function(d) { return d == null; }).remove();
		
		circles.on("mouseover",function(d){
									div.transition()
									.duration(200)
									.style("opacity",.9);
									//.text("MSGP: " + Math.round(d.individ_msgp) + " , Tripod: " + d.sevencs_nce_median)
									div.html(d.Country)
									.style("left",(d3.event.pageX)-5+"px")
									.style("top",(d3.event.pageY)-25+"px");
								})
								.on("mouseout",function(d){
									div.transition()
									.duration(500)
									.style("opacity",0);
								});


		circles.exit().remove();
		//Call X axis
			svg2.append("g")
				.attr("class", "axis")
				.attr("transform","translate(0,"+ (h-padding) +")")
				.call(xAxis);
		//Call Y axis
			svg2.append("g")
				.attr("class","axis")
				.attr("transform","translate("+ padding +",0)")
				.call(yAxis);
				
		}	
	
var units = "Widgets";

var margin = {top: 10, right: 10, bottom: 10, left: 10},
    width = 900 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;

var formatNumber = d3.format(",.0f"),    // zero decimal places
    format = function(d) { return formatNumber(d) + " " + units; },
    color = d3.scale.category20();

// append the svg canvas to the page
var svg = d3.select("#area1").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", 
          "translate(" + margin.left + "," + margin.top + ")");

// Set the sankey diagram properties
var sankey = d3.sankey()
    .nodeWidth(36)
    .nodePadding(10)
    .size([width, height]);

var path = sankey.link();

// load the data
//d3.json("sankey-formatted.json", function(error, graph) {
d3.json("chile_sankey.json", function(error, graph) {
  sankey
      .nodes(graph.nodes)
      .links(graph.links)
      .layout(32);

// add in the links
  var link = svg.append("g").selectAll(".link")
      .data(graph.links)
    .enter().append("path")
      .attr("class", "link")
      .attr("d", path)
      .style("stroke-width", function(d) { return Math.max(1, d.dy); })
      .sort(function(a, b) { return b.dy - a.dy; });

// add the link titles
  link.append("title")
        .text(function(d) {
    		return d.source.name + " → " + 
                d.target.name + "\n" + format(d.value); });

// add in the nodes
  var node = svg.append("g").selectAll(".node")
      .data(graph.nodes)
    .enter().append("g")
      .attr("class", "node")
      .attr("transform", function(d) { 
		  return "translate(" + d.x + "," + d.y + ")"; })
    .call(d3.behavior.drag()
      .origin(function(d) { return d; })
      .on("dragstart", function() { 
		  this.parentNode.appendChild(this); })
      .on("drag", dragmove));

// add the rectangles for the nodes
  node.append("rect")
      .attr("height", function(d) { return d.dy; })
      .attr("width", sankey.nodeWidth())
      .style("fill", function(d) { 
		  return d.color = color(d.name.replace(/ .*/, "")); })
      .style("stroke", function(d) { 
		  return d3.rgb(d.color).darker(2); })
    .append("title")
      .text(function(d) { 
		  return d.name + "\n" + format(d.value); });

// add in the title for the nodes
  node.append("text")
      .attr("x", -6)
      .attr("y", function(d) { return d.dy / 2; })
      .attr("dy", ".35em")
      .attr("text-anchor", "end")
      .attr("transform", null)
      .text(function(d) { return d.name; })
    .filter(function(d) { return d.x < width / 2; })
      .attr("x", 6 + sankey.nodeWidth())
      .attr("text-anchor", "start");

// the function for moving the nodes
  function dragmove(d) {
    d3.select(this).attr("transform", 
        "translate(" + d.x + "," + (
                d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))
            ) + ")");
    sankey.relayout();
    link.attr("d", path);
  }
});

</script>

</body>
</html>
